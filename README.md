## ä¸­æ–‡|[English](https://github.com/jdh-algo/JoyDataForge/blob/main/README-EN.md "readme-en")

# HJOYDATAFORGE:æ•°æ®é”»é€ å·¥å‚

æœ¬é¡¹ç›®æ—¨åœ¨æä¾›ä¸€ä¸ªç”¨äºå¤§æ¨¡å‹æ•°æ®åˆæˆçš„å¼€æºå·¥å…·ç®±ã€‚é€šè¿‡è¯¥å·¥å…·ç®±æä¾›çš„å¤šç§æ•°æ®åˆæˆæ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥é«˜æ•ˆåœ°æ„å»ºé€‚ç”¨äºä¸åŒä¸šåŠ¡éœ€æ±‚çš„æ•°æ®ç®¡é“æµç¨‹ï¼Œä»è€Œæ˜¾è‘—æé«˜æ•°æ®ç”Ÿäº§æ•ˆç‡ã€‚åœ¨æ•°æ®æ„å»ºå®Œæˆåï¼Œå·¥å…·ç®±è¿˜æ”¯æŒä»è¯­ä¹‰å’Œå®ä½“ç­‰å¤šä¸ªå±‚é¢å¯¹æ•°æ®çš„å¤šæ ·æ€§è¿›è¡Œå…¨é¢è¯„ä¼°ã€‚

## èƒŒæ™¯ä»‹ç»

åœ¨å¤§æ¨¡å‹ç®—æ³•çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè™½ç„¶æ¨¡å‹è®­ç»ƒç®—æ³•å·²ç»ç›¸å¯¹æˆç†Ÿï¼Œä½†é«˜è´¨é‡æ•°æ®çš„æ„å»ºä»ç„¶è€—è´¹å¤§é‡çš„äººåŠ›å’Œæ—¶é—´ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé«˜æ•ˆçš„æ•°æ®åˆæˆå·¥å…·æ¥æé«˜å¤§æ¨¡å‹è®­ç»ƒæ•°æ®çš„ç”Ÿäº§æ•ˆç‡ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- **æ•°æ®åˆæˆ**
  * **å•æ¨¡å‹åˆæˆ** ï¼šæ”¯æŒå•ä¸€æ¨¡å‹çš„æ•°æ®åˆæˆã€‚
  * **å¤šæ¨¡å‹æŠ•ç¥¨åˆæˆ** ï¼šé€šè¿‡å¤šä¸ªæ¨¡å‹çš„ç»“æœæŠ•ç¥¨ç”Ÿæˆåˆæˆæ•°æ®ã€‚
  * **å¤šæ¨¡å‹çº§è”åˆæˆ** ï¼šç»“åˆå¤šç§æ¨¡å‹çš„ä¼˜åŠ¿è¿›è¡Œæ•°æ®åˆæˆã€‚
  * **Wizrdæ¼”åŒ–æ•°æ®åˆæˆ** ï¼šä½¿ç”¨Wizrdæ–¹æ³•è¿›è¡Œæ•°æ®æ¼”åŒ–å’Œåˆæˆã€‚
  * **Magpieæ¨¡å‹æŒ‡ä»¤æ•°æ®è’¸é¦** ï¼šé€šè¿‡Magpieæ¨¡å‹æŒ‡ä»¤è¿›è¡Œæ•°æ®è’¸é¦ã€‚
  * **DPOæ•°æ®åˆæˆåŠæ‰“åˆ†** ï¼šæ”¯æŒDPOæ•°æ®åˆæˆå¹¶å¯¹ç»“æœè¿›è¡Œè¯„åˆ†ã€‚
- **æ•°æ®è¯„ä¼°**
  * **Minihashè¿‡æ»¤** ï¼šåˆ©ç”¨minihashç®—æ³•è¿›è¡Œæ•°æ®è¿‡æ»¤ã€‚
  * **Vendi-scoreè¯„ä¼°è¯­ä¹‰å¤šæ ·æ€§** ï¼šä½¿ç”¨vendi-scoreè¯„ä¼°æ•°æ®çš„è¯­ä¹‰å¤šæ ·æ€§ã€‚
  * **ä¿¡æ¯ç†µå’Œè¾›æ™®æ£®æŒ‡æ•°è¯„ä¼°å®ä½“å¤šæ ·æ€§** ï¼šé€šè¿‡ä¿¡æ¯ç†µå’Œè¾›æ™®æ£®æŒ‡æ•°è¿›è¡Œå®ä½“å¤šæ ·æ€§è¯„ä¼°ã€‚
- æ•°æ®ç±»å‹
  - **jsonæ•°æ®**
    å¦‚æœéœ€è¦ä»å·²æœ‰æ•°æ®è¿›è¡Œåˆæˆï¼Œ å½“å‰queryæ”¾åœ¨**â€input"**å­—æ®µï¼Œ å†å²å†…å®¹æ”¾åœ¨**â€œhistory"**ä¸­ã€‚
  - **æ•°æ®æ ·ä¾‹**ï¼š
    ```
    {
       "input": "æ¶‚äº†ç”²ç¡å”‘åçš®è‚¤é•¿çš„ç—˜ç—˜æ²¡æœ‰æ•ˆæœï¼Œæˆ‘åº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ",
       "target": "",
       "summary_content": "æˆ‘çš®è‚¤é•¿äº†è«åŒ¹ç½—æ˜Ÿçš„ç—˜ç—˜,æˆ‘æ¶‚äº†ç”²ç¡å”‘,ä½†æ˜¯æ²¡æœ‰æ•ˆæœã€‚",
       "history": [],
       "tag": "åˆç†ç”¨è¯-ç”¨æ³•ç”¨é‡",
       "task_label": [
          "medicalknowledge",
          "pharmacologyknowledge"
       ],
       "num_task_label": 5
    }
    ```

## å®‰è£…

```bash
#ä»£ç ä¸‹è½½
git clone https://github.com/jdh-algo/JoyDataForge.git

#è¿›å…¥å·¥ç¨‹è·¯å¾„
cd JoyDataForge

#å®‰è£…ä¾èµ–
1ã€python ç¯å¢ƒåˆ›å»º
    1.1 æ¨è Anaconda æ¥ç®¡ç†è™šæ‹Ÿç¯å¢ƒï¼Œ ä¸‹è½½åœ°å€: https://www.anaconda.com/download
    1.2 conda create -n [env_name] python=3.12
    1.3 conda activate [env_name]
2ã€å®‰è£… Poetry:
    pip install poetry
    # å¦‚æœå®‰è£…å¤±è´¥ï¼Œè¯·æ ¹æ®å®˜ç½‘æ¨èçš„å®‰è£…æ–¹å¼: https://python-poetry.org/docs/
3ã€ç”¨ Poetry å®‰è£…å·¥ç¨‹ä¾èµ–:
    poetry install
    #å‚è€ƒæ–‡ä»¶pyproject.tomlä¸­ä¾èµ–åŠç‰ˆæœ¬è¦æ±‚.

```

## ä½¿ç”¨è¯´æ˜

```bash
# åˆæˆå·¥å…·çš„ä½¿ç”¨ç¤ºä¾‹-multi_model voting and post model labeling
# æœ¬ç¤ºä¾‹ä½¿ç”¨å¤šä¸ªå¤§æ¨¡å‹æŠ•ç¥¨è·å–queryçš„æ ‡ç­¾ï¼Œ ç„¶åæŒ‡å®šæ ‡ç­¾çš„æ•°æ®è¿›è¡ŒäºŒæ¬¡æ‰“æ ‡ç­¾æå‡æ•°æ®çš„è´¨é‡
#æ³¨æ„ï¼š
 1ã€æœ¬æ ·ä¾‹æ˜¯åœ¨éœ€è¦åœ¨src.joydataforge.models.llmä¸­å®ç°è‡ªå·±çš„æ¨¡å‹ï¼Œå¯ä»¥æ˜¯apiã€å¯ä»¥æ˜¯è‡ªå·±éƒ¨ç½²æ¨¡å‹ï¼›
 2ã€æœ¬æ ·ä¾‹åœ¨src.joydataforge.config import agent_cdss_one_qa_labeling_prompt as prompt æŒ‡å®šäº†æç¤ºè¯ï¼Œ ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®ç°è‡ªå·±çš„æç¤ºè¯

import os
import sys
import asyncio
import argparse
from pathlib import Path
sys.path.append(str(Path(__file__).parents[2]))
from loguru import logger
from src.joydataforge.models.llm import gpt4o, claude, gpt4o_mini, glm4_flash, JoyLLM
from src.joydataforge.config import agent_cdss_one_qa_labeling_prompt as prompt
from src.joydataforge.components.loader.data_load_and_process import DataLoadAndProcess
from src.joydataforge.memory.cache.data_cache import DataCache
from src.joydataforge.components.synth.joy_synth.data_generate import JoyDataGenerate

def get_args():
    parser = argparse.ArgumentParser(description='Chinese Text Classification')
    parser.add_argument('--model', type=JoyLLM, default=gpt4o, help='Model used for data generation') 
    parser.add_argument('--model_list', type=list, default=[claude, gpt4o_mini, glm4_flash], help='Models for label voting') 
    parser.add_argument('--prompt', type=str, default=prompt, help='Prompt used for data generation') 
    parser.add_argument('--prompt_post_pipline', type=str, default=prompt, help='Prompt used for data generation post pipline') 
    parser.add_argument('--data_read_path', type=str, default="datas/wizard_instruction/example.jsonl", help='Path for data reading')  
    parser.add_argument('--file_type', type=str, default="jsonl", help='data file type')  
    parser.add_argument('--data_write_path', type=str, default="results/cdss_datas_with_votes_post_processing", help='Path to save generated data')  
    parser.add_argument('--data_write_file_name', type=str, default="cdss_agent_data_synth.json", help='File name for saving generated data')  
    parser.add_argument('--task_name', type=str, default="cdss_multi_model_vote_and_post_labeling", help='Task name')  
    parser.add_argument('--from_where', type=str, default="***", help='Data source')   
    parser.add_argument('--method', type=str, choices=[], default="vote_and_pipeline", help='Data generation method')  
    parser.add_argument('--threshold', type=int, default=10, help='Upper limit on the amount of data to process')  
    parser.add_argument('--threshold_low', type=int, default=0, help='Starting position for processing data') 
    parser.add_argument('--max_works', type=int, default=10, help='Number of parallel processing workers') 
    parser.add_argument('--data_cache_path', type=str, default="", help='Path to historical data cache (to avoid regenerating existing data). Can be empty for first-time generation') 
    parser.add_argument('--is_save_caches', type=bool, default=False, help='Whether to save generated data as historical cache') 
    parser.add_argument('--save_cache_path', type=str, default="caches/cachesjson", help='Path to save the cache data') 
    parser.add_argument('--need_post_pipeline_label_list', type=list, default=["BMI", "é¢„æœŸå­•å‘¨", "è¯å“"], help='List of labels requiring multi-stage pipeline processing') 
    base_args = parser.parse_args()
    return base_args

async def main():
    args = get_args()

    data_path_destination = args.data_write_path
    if not os.path.exists(data_path_destination):
        os.makedirs(data_path_destination)
  
    # Data to be excluded or deduplicated; if there are multiple sources, multiple historical caches can be constructed
    caches_1 = DataCache()
    caches_2 = DataCache()
  
    caches_1.cache.update(caches_2.cache)
    logger.info(f"Cache size: {len(caches_1.cache)}")
  
    # Data preprocessing
    data_pre_processor = DataLoadAndProcess(path=args.data_read_path, task=args.task_name, file_type=args.file_type)
  
    # Data generation
    data_generator = JoyDataGenerate(
        model=args.model, 
        prompt=args.prompt, 
        output_file=f'{data_path_destination}/{args.data_write_file_name}_{args.task_name}.json', 
        model_list=args.model_list, 
        method=args.method, 
        caches=caches_1, 
        threshold=args.threshold, 
        threshold_low=args.threshold_low,
        prompt_post_pipline=args.prompt_post_pipline,
        need_post_pipeline_label_list=args.need_post_pipeline_label_list, 
        max_works=args.max_works,
        from_where=args.from_where, 
        task_name=args.task_name,
        data_processor=data_pre_processor)
  
    await data_generator.generate()
  
    # After processing, data can be cached or used to rebuild
    if args.is_save_caches:
        caches_1.save_cache(save_path=args.save_cache_path)
    logger.info(f"Dataset: {args.data_read_path}, labeling processing completed!")

if __name__ == '__main__':
    asyncio.run(main())


```

python examples/model_votes/model_votes_and_pipline.py

æ›´å¤šæ ·ä¾‹å¯å‚è€ƒæ–‡ä»¶å¤¹ï¼š[examples/ ](https://github.com/jdh-algo/JoyDataForge/tree/main/examples "examples")ä¸­çš„ç¤ºä¾‹å†…å®¹ã€‚

## æ•°æ®é›†

æˆ‘ä»¬åˆ©ç”¨[JoyDataForge](https://github.com/jdh-algo/JoyDataForge "æ•°æ®åˆæˆ é”»é€ å‚")å·¥å…·ä¸­çš„[Magpie](https://arxiv.org/abs/2406.08464 "å–œé¹Š")æ–¹æ³•å’Œ[Wizard](https://arxiv.org/abs/2304.12244 "WizardLM")æ–¹æ³•åˆæˆäº†2ä¸ªæ•°æ®é›†ï¼Œå¹¶è¿›è¡Œäº†å¼€æºï¼Œ ä¾›å¤§å®¶å‚è€ƒå’Œä½¿ç”¨ã€‚

æ•°æ®é›†1ï¼š[joy_common_sft_datasets](https://huggingface.co/datasets/jdh-algo-huggingface/joy_common_sft_datasets "magpie")ï¼Œ æ•°æ®é›†æ˜¯åˆ©ç”¨magpie æ–¹æ³•å¯¹[Qwen2-7b-Intruction](https://github.com/QwenLM/Qwen)æ¨¡å‹è¿›è¡Œè’¸é¦ï¼Œ å¯ä»¥ç”¨äºæ¨¡å‹**åˆæœŸ**çš„SFTçš„æŒ‡ä»¤å¾®è°ƒé˜¶æ®µã€‚

æ•°æ®é›†2ï¼š[query_diversity_evolution](https://huggingface.co/datasets/jdh-algo-huggingface/query_diversity_evolution "WizardLM") ï¼Œ æœ¬æ•°æ®é›†æ˜¯åˆ©ç”¨wizardæ–¹æ³•å¯¹ç»™å®šæ•°æ®é›†ä¸­çš„query å†…å®¹è¿›è¡Œæ·±åº¦å’Œå®½åº¦çš„æ¼”åŒ–2è½®å¾—åˆ°ç»“æœï¼Œ æˆ‘ä»¬å¹¶å¯¹æ¼”åŒ–åçš„queryè¿›è¡Œäº†ä»»åŠ¡éš¾åº¦æ‰“åˆ†ï¼Œ ç”¨äºæé«˜queryçš„å¤šæ ·æ€§åŠä»»åŠ¡çš„å¤æ‚åº¦ï¼Œç”¨äºæ¨¡å‹çš„**åé˜¶æ®µ**çš„SFTæŒ‡ä»¤å¾®è°ƒé˜¶æ®µã€‚

## è´¡çŒ®

æè¿°å¦‚ä½•ä¸ºé¡¹ç›®åšå‡ºè´¡çŒ®ï¼ŒåŒ…æ‹¬æŠ¥å‘Šé”™è¯¯ã€æå‡ºåŠŸèƒ½å»ºè®®æˆ–æäº¤ä»£ç ã€‚

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/fooBar`)
3. æäº¤æ›´æ”¹ (`git commit -am 'Add some fooBar'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/fooBar`)
5. åˆ›å»ºæ–°çš„ Pull Request

## å¼•ç”¨

```
@misc{joydataforge2024,
  title={JoyDataForge: An Open Source Toolkit for Large-Scale Data Synthesis},
  author={weili36190429 and lb2158},
  year={2024},
  howpublished={\url{https://github.com/jdh-algo/JoyDataForge.git}},
  note={Version 1.0}
}
```

## é¡¹ç›®è´¡çŒ®è€…

 ``<!-- ALL-CONTRIBUTORS-BADGE:START - Do not remove or modify this section -->
[![All Contributors](https://img.shields.io/badge/all_contributors-13-orange.svg?style=flat-square)](#contributors-)
<!-- ALL-CONTRIBUTORS-BADGE:END -->

<!-- ALL-CONTRIBUTORS-LIST:START - Do not remove or modify this section -->
<!-- prettier-ignore-start -->
<!-- markdownlint-disable -->
<table>
  <tbody>
    <tr>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/weili36190429"><img src="https://avatars.githubusercontent.com/weili36190429?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="https://github.com/jdh-algo/JoyDataForge/jdh-algo/JoyDataForge/commits?author=weili36190429" title="Code">ğŸ’»</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/lb2158"><img src="https://avatars.githubusercontent.com/lb2158?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="https://github.com/jdh-algo/JoyDataForge/jdh-algo/JoyDataForge/pulls?q=is%3Apr+reviewed-by%3Alb2158" title="Reviewed Pull Requests">ğŸ‘€</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/ray075hl"><img src="https://avatars.githubusercontent.com/ray075hl?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#tool-ray075hl" title="Tools">ğŸ”§</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/helizhi1"><img src="https://avatars.githubusercontent.com/helizhi1?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#tool-helizhi1" title="Tools">ğŸ”§</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/ysleep"><img src="https://avatars.githubusercontent.com/ysleep?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#ideas-ysleep" title="Ideas, Planning, & Feedback">ğŸ¤”</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/Luca202412"><img src="https://avatars.githubusercontent.com/Luca202412?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#ideas-Luca202412" title="Ideas, Planning, & Feedback">ğŸ¤”</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/allwellll"><img src="https://avatars.githubusercontent.com/allwellll?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#example-allwellll" title="Examples">ğŸ’¡</a></td>
    </tr>
    <tr>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/wanyueli"><img src="https://avatars.githubusercontent.com/wanyueli?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#example-wanyueli" title="Examples">ğŸ’¡</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/stalwart0465"><img src="https://avatars.githubusercontent.com/stalwart0465?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#content-stalwart0465" title="Content">ğŸ–‹</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/tabhitmy"><img src="https://avatars.githubusercontent.com/tabhitmy?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#content-tabhitmy" title="Content">ğŸ–‹</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/Hansen06"><img src="https://avatars.githubusercontent.com/Hansen06?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#content-Hansen06" title="Content">ğŸ–‹</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/JackZhang199"><img src="https://avatars.githubusercontent.com/JackZhang199?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#content-JackZhang199" title="Content">ğŸ–‹</a></td>
      <td align="center" valign="top" width="14.28%"><a href="https://github.com/kkbossa"><img src="https://avatars.githubusercontent.com/kkbossa?s=100" width="100px;" alt="User's Name"/><br /><sub><b>User's Name</b></sub></a><br /><a href="#content-kkbossa" title="Content">ğŸ–‹</a></td>
    </tr>
  </tbody>
  <tfoot>
    <tr>
      <td align="center" size="13px" colspan="7">
        <img src="https://raw.githubusercontent.com/all-contributors/all-contributors-cli/1b8533af435da9854653492b1327a23a4dbd0a10/assets/logo-small.svg">
          <a href="https://all-contributors.js.org/docs/en/bot/usage">Add your contributions</a>
        </img>
      </td>
    </tr>
  </tfoot>
</table>

<!-- markdownlint-restore -->
<!-- prettier-ignore-end -->

<!-- ALL-CONTRIBUTORS-LIST:END -->

## è”ç³»æ–¹å¼

- é‚®ç®±: liwei1559@jd.com
